"use strict";(self.webpackChunktechnical_tutorial=self.webpackChunktechnical_tutorial||[]).push([[4926],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return d}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},b=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),b=u(a),d=r,g=b["".concat(s,".").concat(d)]||b[d]||p[d]||l;return a?n.createElement(g,i(i({ref:t},c),{},{components:a})):n.createElement(g,i({ref:t},c))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=b;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var u=2;u<l;u++)i[u]=a[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}b.displayName="MDXCreateElement"},7120:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return p}});var n=a(7462),r=a(3366),l=(a(7294),a(3905)),i=["components"],o={},s="Migrate Gitlab from one server to another",u={unversionedId:"devops/gitlab/gitlab-backup-and-restore",id:"devops/gitlab/gitlab-backup-and-restore",title:"Migrate Gitlab from one server to another",description:"This document is mainly for migrating Gitlab (that is installed via Omnibus) version 13.x.x. And it has also been tested by the author.",source:"@site/docs/devops/gitlab/gitlab-backup-and-restore.md",sourceDirName:"devops/gitlab",slug:"/devops/gitlab/gitlab-backup-and-restore",permalink:"/TechnicalTutorial/docs/devops/gitlab/gitlab-backup-and-restore",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/devops/gitlab/gitlab-backup-and-restore.md",tags:[],version:"current",frontMatter:{},sidebar:"devopsSidebar",previous:{title:"Install Gitlab Runner on Ubuntu 20.04 LTS",permalink:"/TechnicalTutorial/docs/devops/gitlab/gitlab-runner-installation-ubuntu"},next:{title:"Deploy A ReactJS App with Gitlab(Self-hosted) CI/CD",permalink:"/TechnicalTutorial/docs/devops/gitlab/gitlab-reactjs-ci-cd"}},c={},p=[{value:"Requirement/Background",id:"requirementbackground",level:2},{value:"IMPORTANT:",id:"important",level:2},{value:"Install a New Gitlab",id:"install-a-new-gitlab",level:2},{value:"Backup Gitlab on the old server",id:"backup-gitlab-on-the-old-server",level:2},{value:"1. Create backup",id:"1-create-backup",level:3},{value:"2. Storing configuration files",id:"2-storing-configuration-files",level:3},{value:"3. Transfer backup files to new server",id:"3-transfer-backup-files-to-new-server",level:3}],b={toc:p};function d(e){var t=e.components,a=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,n.Z)({},b,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"migrate-gitlab-from-one-server-to-another"},"Migrate Gitlab from one server to another"),(0,l.kt)("p",null,"This document is mainly for migrating Gitlab (that is installed via Omnibus) version 13.x.x. And it has also been tested by the author."),(0,l.kt)("p",null,"For more details, please use ",(0,l.kt)("a",{parentName:"p",href:"https://docs.gitlab.com/13.10/ee/raketasks/backup_restore.html"},"offical document")," as reference "),(0,l.kt)("h2",{id:"requirementbackground"},"Requirement/Background"),(0,l.kt)("p",null,"Migrate gitlab 13.5.4 to 13.10.3"),(0,l.kt)("p",null,"Gitlab was installed by using Omnibus"),(0,l.kt)("p",null,"Linux version is Ubuntu 20.04LTS"),(0,l.kt)("h2",{id:"important"},"IMPORTANT:"),(0,l.kt)("p",null,"The old Gitlab version should be exact as the same version as the new Gitlab version"),(0,l.kt)("p",null,"In my case, I upgrade my old ",(0,l.kt)("inlineCode",{parentName:"p"},"Gitlab 13.5.4")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"Gitlab 13.10.3")),(0,l.kt)("p",null,"The upgrade can be done by using"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt-get update\nsudo apt-get upgrade\n")),(0,l.kt)("p",null,"Or you can also install the old Gitlab version on your new server"),(0,l.kt)("h2",{id:"install-a-new-gitlab"},"Install a New Gitlab"),(0,l.kt)("p",null,"Install a new Gitlab on your new server. "),(0,l.kt)("p",null,"You can read ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/PFTian/TechNotes/blob/master/Gitlab/Gitlab%20Installation.md"},"this article")," to install a new gitlab server"),(0,l.kt)("h2",{id:"backup-gitlab-on-the-old-server"},"Backup Gitlab on the old server"),(0,l.kt)("h3",{id:"1-create-backup"},"1. Create backup"),(0,l.kt)("p",null,"For the Gitlab 12.2 or later and installed via Omnibus"),(0,l.kt)("p",null,"Use the following command line to do the backup"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo gitlab-backup create\n")),(0,l.kt)("p",null,"The defualt location of the backup is at"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"/var/opt/gitlab/backups/\n")),(0,l.kt)("p",null,"and named as (In my case)"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n")),(0,l.kt)("p",null,"You can also find your location at ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/gitlab/gitlab.rb")," configuration ",(0,l.kt)("inlineCode",{parentName:"p"},"gitlab_rails['backup_path']")),(0,l.kt)("h3",{id:"2-storing-configuration-files"},"2. Storing configuration files"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"The backup Rake task GitLab provides does not store your configuration files. The primary reason for this is that your database contains items including encrypted information for two-factor authentication and the CI/CD secure variables. Storing encrypted information in the same location as its key defeats the purpose of using encryption in the first place.")),(0,l.kt)("p",null,"At the very ",(0,l.kt)("strong",{parentName:"p"},"minimum"),", you must backup:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/etc/gitlab/gitlab-secrets.json")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/etc/gitlab/gitlab.rb"))),(0,l.kt)("h3",{id:"3-transfer-backup-files-to-new-server"},"3. Transfer backup files to new server"),(0,l.kt)("p",null,"At your old server, create a folder named as ",(0,l.kt)("inlineCode",{parentName:"p"},"old-gitlab")," at your home folder."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir ~/old-gitlab\n")),(0,l.kt)("p",null,"Copy all the files mentioned in step 1 and 2 above to this folder"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp /etc/gitlab/gitlab-secrets.json  ~/old-gitlab/gitlab-secrets.json\nsudo cp /etc/gitlab/gitlab.rb  ~/old-gitlab/gitlab.rb\nsudo cp /var/opt/gitlab/backups/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar  ~/old-gitlab/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n")),(0,l.kt)("p",null,"Transfering all the files from old server to new server (at home folder) by using ",(0,l.kt)("inlineCode",{parentName:"p"},"scp")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"scp -r ~/old-gitlab yourname@newserver.com:~/\n")),(0,l.kt)("ol",{start:4},(0,l.kt)("li",{parentName:"ol"},"Restore the backup on the new server")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"This procedure assumes that:"),(0,l.kt)("ul",{parentName:"blockquote"},(0,l.kt)("li",{parentName:"ul"},"You have installed the exact same version and type (CE/EE) of GitLab Omnibus with which the backup was created."),(0,l.kt)("li",{parentName:"ul"},"You have run sudo gitlab-ctl reconfigure at least once."),(0,l.kt)("li",{parentName:"ul"},"GitLab is running. If not, start it using sudo gitlab-ctl start."))),(0,l.kt)("p",null,"First ensure your backup tar file is in the backup directory described in the gitlab.rb configuration gitlab_rails","['backup_path']",". The default is /var/opt/gitlab/backups. It needs to be owned by the git user."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp ~/old-gitlab/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar /var/opt/gitlab/backups/\nsudo chown git.git /var/opt/gitlab/backups/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n")),(0,l.kt)("p",null,"Stop the processes that are connected to the database. Leave the rest of GitLab running:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo gitlab-ctl stop unicorn\nsudo gitlab-ctl stop puma\nsudo gitlab-ctl stop sidekiq\n# Verify\nsudo gitlab-ctl status\n")),(0,l.kt)("p",null,"Next, restore the backup, specifying the timestamp of the backup you wish to restore:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo gitlab-backup restore BACKUP=1619023211_2021_04_21_13.10.3-ee\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},(0,l.kt)("em",{parentName:"strong"},"NOTE:"))," You must only use the backup file name without ",(0,l.kt)("inlineCode",{parentName:"p"},"_gitlab_backup.tar")," as the value of paramter ",(0,l.kt)("inlineCode",{parentName:"p"},"BACKUP")),(0,l.kt)("p",null,"Next, restore ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/gitlab/gitlab-secrets.json")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/gitlab/gilab.rb")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp ~/old-gitlab/gitlab-secrets.json /etc/gitlab/\nsudo cp ~/old-gitlab/gilab.rb /etc/gitlab/\n")),(0,l.kt)("p",null,"If you use new domain name on the new server, you should also change the old domain name to your new domain name at ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/gitlab/gitlab.rb")),(0,l.kt)("p",null,"Reconfigure, restart and check GitLab:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n# After a while, when gitlab starts completely\nsudo gitlab-rake gitlab:check SANITIZE=true\n")),(0,l.kt)("p",null,"In GitLab 13.1 and later, check database values can be decrypted especially if /etc/gitlab/gitlab-secrets.json was restored, or if a different server is the target for the restore."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo gitlab-rake gitlab:doctor:secrets\n")))}d.isMDXComponent=!0}}]);