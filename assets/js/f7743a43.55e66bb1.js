"use strict";(self.webpackChunktechnical_tutorial=self.webpackChunktechnical_tutorial||[]).push([[5752],{5296:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>l});var a=n(758);const i={},s=a.createContext(i);function r(e){const t=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:t},e.children)}},6544:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"devops/cicd/gitlab/gitlab-backup-and-restore","title":"Migrate Gitlab from one server to another","description":"This document is mainly for migrating Gitlab (that is installed via Omnibus) version 13.x.x. And it has also been tested by the author.","source":"@site/docs/devops/cicd/gitlab/gitlab-backup-and-restore.md","sourceDirName":"devops/cicd/gitlab","slug":"/devops/cicd/gitlab/gitlab-backup-and-restore","permalink":"/TechnicalTutorial/docs/devops/cicd/gitlab/gitlab-backup-and-restore","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"devopsSidebar","previous":{"title":"Install Gitlab Runner on Ubuntu 20.04 LTS","permalink":"/TechnicalTutorial/docs/devops/cicd/gitlab/gitlab-runner-installation-ubuntu"},"next":{"title":"Deploy A ReactJS App with Gitlab(Self-hosted) CI/CD","permalink":"/TechnicalTutorial/docs/devops/cicd/gitlab/gitlab-reactjs-ci-cd"}}');var i=n(6070),s=n(5296);const r={},l="Migrate Gitlab from one server to another",o={},c=[{value:"Requirement/Background",id:"requirementbackground",level:2},{value:"IMPORTANT:",id:"important",level:2},{value:"Install a New Gitlab",id:"install-a-new-gitlab",level:2},{value:"Backup Gitlab on the old server",id:"backup-gitlab-on-the-old-server",level:2},{value:"1. Create backup",id:"1-create-backup",level:3},{value:"2. Storing configuration files",id:"2-storing-configuration-files",level:3},{value:"3. Transfer backup files to new server",id:"3-transfer-backup-files-to-new-server",level:3}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"migrate-gitlab-from-one-server-to-another",children:"Migrate Gitlab from one server to another"})}),"\n",(0,i.jsx)(t.p,{children:"This document is mainly for migrating Gitlab (that is installed via Omnibus) version 13.x.x. And it has also been tested by the author."}),"\n",(0,i.jsxs)(t.p,{children:["For more details, please use ",(0,i.jsx)(t.a,{href:"https://docs.gitlab.com/13.10/ee/raketasks/backup_restore.html",children:"offical document"})," as reference"]}),"\n",(0,i.jsx)(t.h2,{id:"requirementbackground",children:"Requirement/Background"}),"\n",(0,i.jsx)(t.p,{children:"Migrate gitlab 13.5.4 to 13.10.3"}),"\n",(0,i.jsx)(t.p,{children:"Gitlab was installed by using Omnibus"}),"\n",(0,i.jsx)(t.p,{children:"Linux version is Ubuntu 20.04LTS"}),"\n",(0,i.jsx)(t.h2,{id:"important",children:"IMPORTANT:"}),"\n",(0,i.jsx)(t.p,{children:"The old Gitlab version should be exact as the same version as the new Gitlab version"}),"\n",(0,i.jsxs)(t.p,{children:["In my case, I upgrade my old ",(0,i.jsx)(t.code,{children:"Gitlab 13.5.4"})," to ",(0,i.jsx)(t.code,{children:"Gitlab 13.10.3"})]}),"\n",(0,i.jsx)(t.p,{children:"The upgrade can be done by using"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo apt-get update\nsudo apt-get upgrade\n"})}),"\n",(0,i.jsx)(t.p,{children:"Or you can also install the old Gitlab version on your new server"}),"\n",(0,i.jsx)(t.h2,{id:"install-a-new-gitlab",children:"Install a New Gitlab"}),"\n",(0,i.jsx)(t.p,{children:"Install a new Gitlab on your new server."}),"\n",(0,i.jsxs)(t.p,{children:["You can read ",(0,i.jsx)(t.a,{href:"https://github.com/PFTian/TechNotes/blob/master/Gitlab/Gitlab%20Installation.md",children:"this article"})," to install a new gitlab server"]}),"\n",(0,i.jsx)(t.h2,{id:"backup-gitlab-on-the-old-server",children:"Backup Gitlab on the old server"}),"\n",(0,i.jsx)(t.h3,{id:"1-create-backup",children:"1. Create backup"}),"\n",(0,i.jsx)(t.p,{children:"For the Gitlab 12.2 or later and installed via Omnibus"}),"\n",(0,i.jsx)(t.p,{children:"Use the following command line to do the backup"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo gitlab-backup create\n"})}),"\n",(0,i.jsx)(t.p,{children:"The defualt location of the backup is at"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"/var/opt/gitlab/backups/\n"})}),"\n",(0,i.jsx)(t.p,{children:"and named as (In my case)"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n"})}),"\n",(0,i.jsxs)(t.p,{children:["You can also find your location at ",(0,i.jsx)(t.code,{children:"/etc/gitlab/gitlab.rb"})," configuration ",(0,i.jsx)(t.code,{children:"gitlab_rails['backup_path']"})]}),"\n",(0,i.jsx)(t.h3,{id:"2-storing-configuration-files",children:"2. Storing configuration files"}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"The backup Rake task GitLab provides does not store your configuration files. The primary reason for this is that your database contains items including encrypted information for two-factor authentication and the CI/CD secure variables. Storing encrypted information in the same location as its key defeats the purpose of using encryption in the first place."}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["At the very ",(0,i.jsx)(t.strong,{children:"minimum"}),", you must backup:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"/etc/gitlab/gitlab-secrets.json"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"/etc/gitlab/gitlab.rb"})}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"3-transfer-backup-files-to-new-server",children:"3. Transfer backup files to new server"}),"\n",(0,i.jsxs)(t.p,{children:["At your old server, create a folder named as ",(0,i.jsx)(t.code,{children:"old-gitlab"})," at your home folder."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"mkdir ~/old-gitlab\n"})}),"\n",(0,i.jsx)(t.p,{children:"Copy all the files mentioned in step 1 and 2 above to this folder"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo cp /etc/gitlab/gitlab-secrets.json  ~/old-gitlab/gitlab-secrets.json\nsudo cp /etc/gitlab/gitlab.rb  ~/old-gitlab/gitlab.rb\nsudo cp /var/opt/gitlab/backups/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar  ~/old-gitlab/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Transfering all the files from old server to new server (at home folder) by using ",(0,i.jsx)(t.code,{children:"scp"})]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"scp -r ~/old-gitlab yourname@newserver.com:~/\n"})}),"\n",(0,i.jsxs)(t.ol,{start:"4",children:["\n",(0,i.jsx)(t.li,{children:"Restore the backup on the new server"}),"\n"]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"This procedure assumes that:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"You have installed the exact same version and type (CE/EE) of GitLab Omnibus with which the backup was created."}),"\n",(0,i.jsx)(t.li,{children:"You have run sudo gitlab-ctl reconfigure at least once."}),"\n",(0,i.jsx)(t.li,{children:"GitLab is running. If not, start it using sudo gitlab-ctl start."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"First ensure your backup tar file is in the backup directory described in the gitlab.rb configuration gitlab_rails['backup_path']. The default is /var/opt/gitlab/backups. It needs to be owned by the git user."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo cp ~/old-gitlab/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar /var/opt/gitlab/backups/\nsudo chown git.git /var/opt/gitlab/backups/1619023211_2021_04_21_13.10.3-ee_gitlab_backup.tar\n"})}),"\n",(0,i.jsx)(t.p,{children:"Stop the processes that are connected to the database. Leave the rest of GitLab running:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo gitlab-ctl stop unicorn\nsudo gitlab-ctl stop puma\nsudo gitlab-ctl stop sidekiq\n# Verify\nsudo gitlab-ctl status\n"})}),"\n",(0,i.jsx)(t.p,{children:"Next, restore the backup, specifying the timestamp of the backup you wish to restore:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo gitlab-backup restore BACKUP=1619023211_2021_04_21_13.10.3-ee\n"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.em,{children:(0,i.jsx)(t.strong,{children:"NOTE:"})})," You must only use the backup file name without ",(0,i.jsx)(t.code,{children:"_gitlab_backup.tar"})," as the value of paramter ",(0,i.jsx)(t.code,{children:"BACKUP"})]}),"\n",(0,i.jsxs)(t.p,{children:["Next, restore ",(0,i.jsx)(t.code,{children:"/etc/gitlab/gitlab-secrets.json"})," and ",(0,i.jsx)(t.code,{children:"/etc/gitlab/gilab.rb"})]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo cp ~/old-gitlab/gitlab-secrets.json /etc/gitlab/\nsudo cp ~/old-gitlab/gilab.rb /etc/gitlab/\n"})}),"\n",(0,i.jsxs)(t.p,{children:["If you use new domain name on the new server, you should also change the old domain name to your new domain name at ",(0,i.jsx)(t.code,{children:"/etc/gitlab/gitlab.rb"})]}),"\n",(0,i.jsx)(t.p,{children:"Reconfigure, restart and check GitLab:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"sudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n# After a while, when gitlab starts completely\nsudo gitlab-rake gitlab:check SANITIZE=true\n"})}),"\n",(0,i.jsx)(t.p,{children:"In GitLab 13.1 and later, check database values can be decrypted especially if /etc/gitlab/gitlab-secrets.json was restored, or if a different server is the target for the restore."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"sudo gitlab-rake gitlab:doctor:secrets\n"})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);